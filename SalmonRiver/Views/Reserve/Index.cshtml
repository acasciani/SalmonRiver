@model SalmonRiver.Models.TemporaryReservationViewModel

@{
    ViewBag.Title = "Complete Reservation";
}

@section scripts{
    <script type="text/javascript">
        $('#CancelHold').click(function () {
            $.post('/Reserve/CancelTemporaryHold', {}, function (data, status, xhr) {
                window.location.replace("/");
            }).fail(function () {

            });
        });
    </script>
    <script type="text/javascript" src="http://js.squareup.com/v2/paymentform"></script>

    <script>
        var paymentForm = new SqPaymentForm({
            applicationId: 'sandbox-sq0idp-0HutUDsnupbboc2BoBxPXQ', // <-- REQUIRED: Add Application ID
            inputClass: 'form-control',
            cardNumber: {
                elementId: 'sq-card-number',
                placeholder: '•••• •••• •••• ••••'
            },
            cvv: {
                elementId: 'sq-cvv',
            },
            expirationDate: {
                elementId: 'sq-expiration-date',
                placeholder: 'MM/YY'
            },
            postalCode: {
                elementId: 'sq-postal-code'
            },
            callbacks: {
                cardNonceResponseReceived: function (errors, nonce, cardData) {
                    if (errors) {
                        // handle errors
                        errors.forEach(function (error) {
                            switch (error.field) {
                                case 'cardNumber':
                                    $('.card-number .validation-sq').removeClass('hidden');
                                    $('.card-number').removeClass('has-success');
                                    $('.card-number').addClass('has-error');
                                    $('.card-number .form-control-feedback').removeClass('glyphicon-ok');
                                    $('.card-number .form-control-feedback').addClass('glyphicon-remove');
                                    if (error.message && error.message !== '') { $('.card-number .validation-sq').text(error.message); }
                                    break;

                                case 'expirationDate':
                                    $('.expiration-date .validation-sq').removeClass('hidden');
                                    $('.expiration-date').removeClass('has-success');
                                    $('.expiration-date').addClass('has-error');
                                    $('.expiration-date .form-control-feedback').removeClass('glyphicon-ok');
                                    $('.expiration-date .form-control-feedback').addClass('glyphicon-remove');
                                    if (error.message && error.message !== '') { $('.expiration-date .validation-sq').text(error.message); }
                                    break;

                                case 'cvv':
                                    $('.cvv .validation-sq').removeClass('hidden');
                                    $('.cvv').removeClass('has-success');
                                    $('.cvv').addClass('has-error');
                                    $('.cvv .form-control-feedback').removeClass('glyphicon-ok');
                                    $('.cvv .form-control-feedback').addClass('glyphicon-remove');
                                    if (error.message && error.message !== '') { $('.cvv .validation-sq').text(error.message); }
                                    break;

                                case 'postalCode':
                                    $('.postal-code .validation-sq').removeClass('hidden');
                                    $('.postal-code').removeClass('has-success');
                                    $('.postal-code').addClass('has-error');
                                    $('.postal-code .form-control-feedback').removeClass('glyphicon-ok');
                                    $('.postal-code .form-control-feedback').addClass('glyphicon-remove');
                                    if (error.message && error.message !== '') { $('.postal-code .validation-sq').text(error.message); }
                                    break;

                                default: break;
                            }

                            if (error.type != 'VALIDATION_ERROR') {
                                $('#AlertBox').innerHeight += '<div class="alert alert-warning alert-dismissible" role="alert" id="AlertBox"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                                    '<div class="content">An error occurred while trying to prepare your payment. Please try again and if the problem persists please contact us.</div></div>';
                            }
                        });
                    } else {
                        // handle nonce
                        console.log('Nonce received:');
                        console.log(nonce);
                    }
                },
                unsupportedBrowserDetected: function () {
                    alert('Your browser is not supported. Please contact us to make reservations.');
                }
            }
        });

        function requestCardNonce() {
            $('.validation-sq').addClass('hidden');
            $('.form-control-feedback').addClass('glyphicon-ok');
            $('.form-control-feedback').removeClass('glyphicon-remove');
            $('.has-feedback').removeClass('has-error');
            $('.has-feedback').addClass('has-success');

            paymentForm.requestCardNonce();
            return false;
        }
    </script>
}

@section styles {
    <style type="text/css">
        .checkin .dateinfo, .checkout .dateinfo {
            background-color: #f5f5f5;
            border-right: solid 1px #ddd;
        }

        .dateinfo .date {
            font-weight: bold;
        }

        .dateinfo .time {
            font-style: italic;
        }

        .checkin .description, .checkout .description {
            font-size: 1.3em;
        }

        .dl-horizontal.details-of-stay {
            margin-bottom: 0px;
        }

        .hidden {
            display: none;
        }
    </style>
}


@if (Model == null)
{
    <div class="container main-content">
        <div class="row">
            <div class="col-sm-12">
                <div class="alert alert-danger" role="alert">
                    You have not selected any dates or your session as expired. @Html.ActionLink("Please click here to book now.", "Index", "Home")
                </div>
            </div>
        </div>
    </div>
}
else
{
    <!-- alert box -->
    <div style="position: fixed; top: 20px; width: 100%; z-index: 1000">
        <div class="container-fluid" id="AlertBox">

        </div>
    </div>

    <div class="container main-content">
        @using (Html.BeginForm())
        {
            @Html.AntiForgeryToken();
            <div class="row">
                <div class="col-sm-12">
                    <div class="alert alert-success" role="alert">
                        <strong>Confirmation and Payment</strong> - Your session will expire at @Model.Expires.ToLocalTime().ToString("h:mm tt"). After that you will no longer have first priority to the dates you selected, unless you rebook. Please confirm and proceed to process your payment.
                    </div>
                </div>
            </div>


            <div class="row">
                <div class="col-sm-12">
                    <h2>Details About Your Stay</h2>
                </div>
                <div class="col-xs-8 col-sm-6">
                    <div class="row">
                        <div class="col-sm-12 checkin">
                            <div class="panel panel-default">
                                <div class="panel-body col-sm-6 col-md-4 text-center dateinfo">
                                    <div class="date text-center">Wednesday, June 1</div>
                                    <div class="time text-center">11:00 am</div>
                                </div>
                                <div class="panel-body col-sm-6 col-md-8 description text-center">Check In</div>
                                <div style="clear: both;"></div>
                            </div>
                        </div>

                        <div class="col-sm-12 checkout">
                            <div class="panel panel-default">
                                <div class="panel-body col-sm-6 col-md-4 text-center dateinfo">
                                    <div class="date text-center">Friday, June 3</div>
                                    <div class="time text-center">11:00 am</div>
                                </div>
                                <div class="panel-body col-sm-6 col-md-8 description text-center">Check Out</div>
                                <div style="clear: both;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xs-4 col-sm-6">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <dl class="dl-horizontal details-of-stay">
                                <dt># of Guests:</dt>
                                <dd>3</dd>

                                <dt>Price Per Night:</dt>
                                <dd>$125</dd>

                                <dt>Length of Stay:</dt>
                                <dd>6 nights</dd>

                                <dt>Total Cost:</dt>
                                <dd>$459.00</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>


            <div class="row">
                <div class="col-sm-12">
                    <h2>Contact Information</h2>
                </div>
                <div class="col-xs-12">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <div class="form-group">
                                <label for="FullName">Full Name</label>
                                <input type="text" class="form-control" id="FullName">
                            </div>
                            <div class="form-group">
                                <label for="EmailAddress">Email Address</label>
                                <input type="email" class="form-control" id="EmailAddress">
                            </div>
                            <div class="form-group">
                                <label for="PhoneNumber">Phone Number</label>
                                <input type="tel" class="form-control" id="PhoneNumber">
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="row">
                <div class="col-sm-12">
                    <h2>Billing Information</h2>
                </div>
                <div class="col-xs-12">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="form-group">
                                        <label for="CardName">Name on Card</label>
                                        <input type="text" class="form-control" id="CardName">
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <div class="form-group has-feedback card-number">
                                        <label for="CCNumber">Credit Card Number</label>
                                        <div id="sq-card-number"></div>
                                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>

                                        <span class="text-danger hidden validation-sq">An error occurred with your card number.</span>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="form-group has-feedback cvv">
                                        <label for="CVV2">CVV</label>
                                        <div id="sq-cvv"></div>
                                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>

                                        <span class="text-danger hidden validation-sq">An error occurred with your card's CVV value.</span>
                                    </div>
                                </div>

                                <div class="col-sm-6">
                                    <div class="form-group has-feedback expiration-date">
                                        <label for="ExpirationMonth">Expiration Date</label>
                                        <div id="sq-expiration-date"></div>
                                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>

                                        <span class="text-danger hidden validation-sq">An error occurred with your card's expiration date.</span>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group has-feedback postal-code">
                                        <label for="sq-postal-code">Postal Code</label>

                                        <div id="sq-postal-code"></div>
                                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>

                                        <span class="text-danger hidden validation-sq">An error occurred with your postal code.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <button type="submit" onclick="return requestCardNonce()" class="btn btn-default">
                        <span class="glyphicon glyphicon-credit-card"></span>&nbsp;Process Payment
                    </button>

                    <button type="button" class="btn btn-danger" id="CancelHold">
                        &nbsp;Cancel Reservation
                    </button>
                </div>
            </div>

        }

    </div>
}